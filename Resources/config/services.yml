services:
    oka_api.object_manager:
        class: Doctrine\Common\Persistence\ObjectManager
        arguments: [ '' ]
        public: false

# Services
    oka_api.error_response.factory:
        class: Oka\ApiBundle\Service\ErrorResponseFactory
        arguments: [ '%oka_api.response.error_builder_class%' ]

# User Provider
    oka_api.wsse_user_provider:
        class: Oka\ApiBundle\Security\User\WsseUserProvider
        arguments: [ '@oka_api.object_manager', '%oka_api.client_class%' ]

#    oka_api.jwt_user_provider:
#        class: Oka\ApiBundle\Security\User\JwtUserProvider
#        arguments: [ '@oka_api.object_manager', '%oka_api.user_class%' ]

# Firewalls Request Matcher
    oka_api.request_matcher.host:
        class: Oka\ApiBundle\Http\HostRequestMatcher
        arguments: [ '%oka_api.http_host%' ]
        public: false

    oka_api.wsse.firewall.request_matcher:
        class: Oka\ApiBundle\Http\WsseRequestMatcher
        arguments: [ '@oka_api.request_matcher.host' ]
        public: false

#    oka_api.jwt.firewall.request_matcher:
#        class: Oka\ApiBundle\Http\JwtRequestMatcher
#        arguments: [ '@oka_api.request_matcher.host', '' ]
#        public: false

# Authentication Provider
    oka_api.wsse.security.authentication.provider:
        class: Oka\ApiBundle\Security\Authentication\Provider\WsseProvider
        arguments: [ '', '%kernel.cache_dir%/security/nonces', '' ]
        public: false

    oka_api.wsse.security.authentication.listener:
        class: Oka\ApiBundle\Security\Firewall\WsseListener
        parent: oka_api.util.logger.helper
        arguments: [ '@security.token_storage', '@security.authentication.manager', '@oka_api.error_response.factory' ]
        public: false
#        tags:
#          - { name: monolog.logger, channel: '%oka_api.wsse.log_channel%' }

#    oka_api.jwt.authentication.guard.token_authenticator:
#      class: Oka\ApiBundle\Security\Guard\JwtGuardAuthenticator
#      arguments: [ '@oka_api.util.json_web_token.helper', '@oka_api.error_response.factory', '%oka_api.user_class%' ]

# Listeners
    oka_api.request.event_listener:
        class:  Oka\ApiBundle\EventListener\RequestListener
        parent: oka_api.util.logger.helper
        arguments:  [ '@oka_api.request_matcher.host', '@oka_api.error_response.factory', '%kernel.environment%' ]
        tags:
          - { name: kernel.event_subscriber }

    oka_api.annotation.event_listener:
        class:  Oka\ApiBundle\EventListener\AnnotationListener
        parent: oka_api.util.logger.helper
        arguments:  [ '@annotation_reader', '@validator', '@oka_api.error_response.factory' ]
        tags:
          - { name: kernel.event_subscriber }

    oka_api.cors_support.event_listener:
        class:  Oka\ApiBundle\EventListener\CorsSupportListener
        parent: oka_api.util.logger.helper
        arguments:  [ [] ]
        public: false

# Utils
    oka_api.util.logger.helper:
        class:  Oka\ApiBundle\Service\LoggerHelper
        abstract: true
        calls:
          - [ setLogger, ['@logger'] ]
        tags:
          - { name: monolog.logger, channel: '%oka_api.log_channel%' }

#    oka_api.util.json_web_token.helper:
#        class:  Oka\ApiBundle\Util\JSONWebTokenHelper
#        parent: oka_api.util.logger.helper
#        arguments: [ '%oka_api.http_host%', '%secret%' ]
#        tags:
#          - { name: monolog.logger, channel: '%oka_api.jwt.log_channel%' }